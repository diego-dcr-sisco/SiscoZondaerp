function showSpinner() {
    $("#fullscreen-spinner").removeClass("d-none");
}

function hideSpinner() {
    $("#fullscreen-spinner").addClass("d-none");
}

function updateOrder() {
    // Solo incluir la firma si ha sido modificada
    var signatureChanged = $("#signature-changed").val() === '1';
    var signatureData = signatureChanged ? $("#signature-base64").val() : null;
    
    var order = {
        id: parseInt($("#order-id").val()),
        programmed_date: $("#programmed-date").val(),
        completed_date:
            $("#completed-date").val() != ""
                ? $("#completed-date").val()
                : null,
        start_time: $("#start-time").val(),
        end_time: $("#end-time").val() != "" ? $("#end-time").val() : null,
        status: parseInt($("#order-status").val()),
        folio: parseInt($("#folio").val()),
        closed_by: $("#closed-by").val() !== "" ? parseInt($("#closed-by").val()) : null,
        signed_by: $("#signed-by").val(),
        signature_base64: signatureData,
        signature_updated: signatureChanged ? 1 : 0,
    };

    // Validar tamaño de la firma solo si ha sido modificada
    if (signatureChanged && order.signature_base64 && order.signature_base64.length > 0) {
        const base64Size = order.signature_base64.length * 0.75; // Aproximado en bytes
        const maxSize = 3 * 1024 * 1024; // 3MB máximo
        
        if (base64Size > maxSize) {
            alert('La firma es demasiado grande para ser guardada. Por favor, usa una imagen más pequeña.');
            console.error('Signature too large:', Math.round(base64Size / 1024 / 1024) + 'MB');
            return;
        }
        console.log('Firma modificada, enviando nueva firma de tamaño:', Math.round(order.signature_base64.length / 1024) + 'KB');
    } else if (!signatureChanged) {
        console.log('Firma no modificada, no se enviará al servidor');
    }

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    
    // Verificar que tenemos el token CSRF
    if (!csrfToken) {
        alert("Error: No se encontró el token CSRF. Por favor, recarga la página.");
        console.error("CSRF token not found in meta tag");
        return;
    }

    var new_formdata = new FormData();
    new_formdata.append("order", JSON.stringify(order));
    new_formdata.append("_token", csrfToken);

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/order/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        timeout: 30000, // 30 segundos timeout para firmas grandes
        success: function (response) {
            if (response.success) {
                alert("Orden almacenada!");
            } else {
                alert("Error al guardar la orden: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error details:", xhr.responseText);
            var errorMsg = "Error al actualizar la orden";
            
            if (xhr.status === 403) {
                errorMsg = "Error 403: Acceso denegado. Tu sesión puede haber expirado. Por favor, recarga la página.";
            } else if (xhr.status === 419) {
                errorMsg = "Error 419: Token CSRF expirado. Por favor, recarga la página.";
            } else if (xhr.status === 413 || xhr.status === 0) {
                errorMsg = "Error: La petición es demasiado grande. La firma puede ser muy pesada. Intenta con una imagen más pequeña.";
            } else if (status === 'timeout') {
                errorMsg = "Error: La petición tardó demasiado. La firma puede ser muy pesada.";
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else {
                errorMsg += ": " + error;
            }
            
            alert(errorMsg);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateCustomer() {
    var customer = {
        id: parseInt($("#customer-id").val()),
        name: $("#customer-name").val(),
        email:
            $("#customer-email").val() != ""
                ? $("#customer-email").val()
                : null,
        rfc: $("#customer-rfc").val() != "" ? $("#customer-rfc").val() : null,
        address: $("#customer-address").val(),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    
    // Verificar que tenemos el token CSRF
    if (!csrfToken) {
        alert("Error: No se encontró el token CSRF. Por favor, recarga la página.");
        console.error("CSRF token not found in meta tag");
        return;
    }

    var new_formdata = new FormData();
    new_formdata.append("customer", JSON.stringify(customer));
    new_formdata.append("_token", csrfToken);

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/customer/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                alert("Cliente almacenado!");
            } else {
                alert("Error al guardar el cliente: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error details:", xhr.responseText);
            var errorMsg = "Error al actualizar el cliente";
            
            if (xhr.status === 403) {
                errorMsg = "Error 403: Acceso denegado. Tu sesión puede haber expirado. Por favor, recarga la página.";
            } else if (xhr.status === 419) {
                errorMsg = "Error 419: Token CSRF expirado. Por favor, recarga la página.";
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else {
                errorMsg += ": " + error;
            }
            
            alert(errorMsg);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateDescription(service_id) {
    var description = {
        service_id: parseInt(service_id),
        text: $(`#service${service_id}-text`).summernote("code"),
        can_propagate: $(`#service${service_id}-can-propagate`).is(":checked"),
        order_id: parseInt($("#order-id").val()),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    
    // Verificar que tenemos el token CSRF
    if (!csrfToken) {
        alert("Error: No se encontró el token CSRF. Por favor, recarga la página.");
        console.error("CSRF token not found in meta tag");
        return;
    }

    var new_formdata = new FormData();
    new_formdata.append("description", JSON.stringify(description));
    new_formdata.append("_token", csrfToken);

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/description/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                alert("Descripción actualizada!");
            } else {
                alert("Error al actualizar la descripción: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error details:", xhr.responseText);
            var errorMsg = "Error al actualizar la descripción";
            
            if (xhr.status === 403) {
                errorMsg = "Error 403: Acceso denegado. Tu sesión puede haber expirado. Por favor, recarga la página.";
            } else if (xhr.status === 419) {
                errorMsg = "Error 419: Token CSRF expirado. Por favor, recarga la página.";
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else {
                errorMsg += ": " + error;
            }
            
            alert(errorMsg);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function updateNotes() {
    var notes = {
        text: $("#order-notes").summernote("code"),
        order_id: parseInt($("#order-id").val()),
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    
    // Verificar que tenemos el token CSRF
    if (!csrfToken) {
        alert("Error: No se encontró el token CSRF. Por favor, recarga la página.");
        console.error("CSRF token not found in meta tag");
        return;
    }

    var new_formdata = new FormData();
    new_formdata.append("notes", JSON.stringify(notes));
    new_formdata.append("_token", csrfToken);

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/notes/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                $('#notes').val(notes.text);
                alert("Notas actualizada!");
            } else {
                alert("Error al actualizar las notas: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error details:", xhr.responseText);
            var errorMsg = "Error al actualizar las notas";
            
            if (xhr.status === 403) {
                errorMsg = "Error 403: Acceso denegado. Tu sesión puede haber expirado. Por favor, recarga la página.";
            } else if (xhr.status === 419) {
                errorMsg = "Error 419: Token CSRF expirado. Por favor, recarga la página.";
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else {
                errorMsg += ": " + error;
            }
            
            alert(errorMsg);
        },
        complete: function() {
            hideSpinner();
        }
    });
}

function deleteSignature() {
    if (!confirm("¿Está seguro de que desea eliminar la firma? Esta acción no se puede deshacer.")) {
        return;
    }

    var order = {
        id: parseInt($("#order-id").val()),
        programmed_date: $("#programmed-date").val(),
        completed_date: $("#completed-date").val() != "" ? $("#completed-date").val() : null,
        start_time: $("#start-time").val(),
        end_time: $("#end-time").val() != "" ? $("#end-time").val() : null,
        status: parseInt($("#order-status").val()),
        closed_by: $("#closed-by").val() !== "" ? parseInt($("#closed-by").val()) : null,
        signed_by: "",
        signature_base64: "",
    };

    var csrfToken = $('meta[name="csrf-token"]').attr("content");
    
    // Verificar que tenemos el token CSRF
    if (!csrfToken) {
        alert("Error: No se encontró el token CSRF. Por favor, recarga la página.");
        console.error("CSRF token not found in meta tag");
        return;
    }

    var new_formdata = new FormData();
    new_formdata.append("order", JSON.stringify(order));
    new_formdata.append("_token", csrfToken);

    console.log('Eliminando firma de la orden');

    showSpinner();

    $.ajax({
        type: "POST",
        url: "/report/order/update",
        data: new_formdata,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        processData: false,
        contentType: false,
        timeout: 10000, // 10 segundos timeout
        success: function (response) {
            if (response.success) {
                // Limpiar la firma en el frontend
                $("#signed-by").val("");
                $("#signature-base64").val("");
                $("#signature-changed").val("1");
                $("#signature-preview").attr("src", "");
                $("#signature-preview").hide();
                
                alert("Firma eliminada correctamente!");
                location.reload(); // Recargar para reflejar los cambios
            } else {
                alert("Error al eliminar la firma: " + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error("Error details:", xhr.responseText);
            var errorMsg = "Error al eliminar la firma";
            
            if (xhr.status === 403) {
                errorMsg = "Error 403: Acceso denegado. Tu sesión puede haber expirado. Por favor, recarga la página.";
            } else if (xhr.status === 419) {
                errorMsg = "Error 419: Token CSRF expirado. Por favor, recarga la página.";
            } else if (status === 'timeout') {
                errorMsg = "Error: La petición tardó demasiado. Intenta nuevamente.";
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else {
                errorMsg += ": " + error;
            }
            
            alert(errorMsg);
        },
        complete: function() {
            hideSpinner();
        }
    });
}
