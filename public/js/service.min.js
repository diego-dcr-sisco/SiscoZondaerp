var services_data = [];
var selected_services = [];
var service_costs = [];

$(function () {
    selected_services = contain_selected_services || [];
    console.log("Initial Selected Services:", selected_services);
    displaySelectedServices();
});

function searchService() {
    var item = $("#services-list");
    var html = "";
    var modal = $("#serviceModal");

    if ($("#search-service-input").val().length > 0) {
        getService(function (services) {
            services_data = services;
            if (services.length > 0) {
                // Construir la tabla de servicios
                html = `
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50px">
                                        <input type="checkbox" id="selectAllServices" onchange="toggleSelectAllServices(this)">
                                    </th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Línea</th>
                                    <th>Plagas</th>
                                    <th>Métodos</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>`;

                // Agregar cada servicio como una fila en la tabla
                services.forEach((service) => {
                    const isSelected = selected_services.some(
                        (item) => item.id == service.id,
                    );
                    html += `
                                <tr class="service-row ${
                                    isSelected ? "table-primary" : ""
                                }">
                                    <td>
                                        <input type="checkbox" class="service-checkbox"
                                            name="service_ids[]"
                                            value="${service.id}"
                                            data-id="${service.id}"
                                            data-name="${service.name}"
                                            data-type="${service.type}"
                                            data-line="${service.bussLine}"
                                            data-cost="${service.cost}"
                                            data-prefix="${service.prefix}"
                                            ${isSelected ? "checked" : ""}
                                            onchange="setService(${
                                                service.id
                                            })">
                                    </td>
                                    <td>
                                        <strong>${service.name}</strong>
                                    </td>
                                    <td>${service.type}</td>
                                    <td>${service.bussLine}</td>
                                    <td>
                                        <small class="text-muted">${shortenString(
                                            service.pests.length > 0
                                                ? service.pests.join(", ")
                                                : "S/P",
                                        )}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">${shortenString(
                                            service.appMethods.length > 0
                                                ? service.appMethods.join(", ")
                                                : "S/M",
                                        )}</small>
                                    </td>
                                    <td class="text-success">
                                        $${service.cost}
                                    </td>
                                </tr>`;
                });

                // Cerrar la tabla
                html += `
                            </tbody>
                        </table>
                    </div>`;

                item.html(html);
                modal.modal("show");

                // Inicializar funcionalidades
                initializeServiceModal();
            } else {
                item.html(
                    '<div class="alert alert-danger">No se encontraron servicios</div>',
                );
                modal.modal("show");
            }
        });
    } else {
        alert("Debes introducir al menos 1 dato de búsqueda.");
    }
}

function shortenString(str) {
    var size = 30;
    if (str.length > size) {
        return str.substring(0, size) + "...";
    }
    return str;
}

function getService(callback) {
    const formData = new FormData();
    const csrfToken = $('meta[name="csrf-token"]').attr("content");
    var url = "";

    url = $("#url-service-input").val();
    formData.append("search_service_input", $("#search-service-input").val());

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            const services = response.services;
            const service_types = response.service_types;
            const business_lines = response.business_lines;
            const pests = response.pests;
            const app_methods = response.app_methods;

            if (services.length > 0) {
                callback(
                    services.map((service, i) => {
                        return {
                            id: service.id,
                            prefix: service.prefix,
                            name: service.name,
                            type: service_types[i],
                            bussLine: business_lines[i],
                            pests: pests[i],
                            appMethods: app_methods[i],
                            status: selected_services.some(
                                (item) => item.id == service.id,
                            ),
                            cost: service.cost ?? "---",
                            description: service.description,
                            //settings: [],
                        };
                    }),
                );
            } else {
                callback([]);
            }
        },
        error: function (error) {
            console.error(error);
            callback([]);
        },
    });
}
// configureServiceModalLabel
// Función para inicializar el modal de servicios
function initializeServiceModal() {
    // Inicializar búsqueda en tiempo real
    $("#serviceSearch").on("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = $(".service-row");

        rows.each(function () {
            const $row = $(this);
            const name = $row.find("td:nth-child(3)").text().toLowerCase();
            const type = $row.find("td:nth-child(4)").text().toLowerCase();
            const line = $row.find("td:nth-child(5)").text().toLowerCase();

            if (
                name.includes(searchTerm) ||
                type.includes(searchTerm) ||
                line.includes(searchTerm)
            ) {
                $row.show();
            } else {
                $row.hide();
            }
        });
    });

    // Actualizar contador
    updateSelectedServicesCount();
}

// Función para seleccionar/deseleccionar todos los servicios
function toggleSelectAllServices(checkbox) {
    const isChecked = $(checkbox).is(":checked");
    $(".service-checkbox").prop("checked", isChecked).trigger("change");
}

// Función para actualizar contador de servicios seleccionados
function updateSelectedServicesCount() {
    const selectedCount = $(".service-checkbox:checked").length;
    $("#selected-services-count").text(
        selectedCount + " servicio(s) seleccionado(s)",
    );

    // Calcular costo total
    let totalCost = 0;
    $(".service-checkbox:checked").each(function () {
        totalCost += parseFloat($(this).data("cost")) || 0;
    });

    $("#total-cost").text("Total: $" + totalCost.toFixed(2));
}

// Función para seleccionar/deseleccionar servicio
function setService(service_id) {
    const checkbox = $(`.service-checkbox[value="${service_id}"]`);
    const isChecked = checkbox.is(":checked");
    const row = checkbox.closest("tr");

    if (isChecked) {
        // Agregar servicio a seleccionados
        const service = services_data.find((item) => item.id == service_id);
        if (
            service &&
            !selected_services.some((item) => item.id == service_id)
        ) {
            selected_services.push({
                id: service_id,
                prefix: service.prefix,
                name: service.name,
                type: service.type,
                line: service.bussLine,
                cost: service.cost,
                description: service.description,
                //settings: [],
            });

            if (typeof services_configuration !== "undefined") {
                services_configuration.push({
                    service_id: service.id,
                    description: service.description,
                });
            }
        }
        row.addClass("table-primary");
    } else {
        // Remover servicio de seleccionados
        const index = selected_services.findIndex(
            (item) => item.id == service_id,
        );
        if (index !== -1) {
            selected_services.splice(index, 1);
        }
        row.removeClass("table-primary");
    }

    updateSelectedServicesCount();
}

// Función para confirmar selección de servicios
function confirmServicesSelection() {
    if (selected_services.length > 0) {
        // Mostrar servicios seleccionados
        displaySelectedServices();
        // Cerrar modal
        $("#serviceModal").modal("hide");

        // Mostrar mensaje de éxito
        showSuccessMessage(
            selected_services.length +
                " servicio(s) seleccionado(s) correctamente",
        );
    } else {
        showErrorMessage("Por favor selecciona al menos un servicio");
    }
}

function showSuccessMessage(message) {
    alert(`✅ ${message}`);
}

// Función para mostrar servicios seleccionados
function displaySelectedServices() {
    const $container = $("#selected-services-container");
    let html = "";

    console.log("Selected Services:", selected_services);
    //$container.empty();
    if (selected_services.length > 0) {
        html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Línea</th>
                            <th>Configuraciones</th>
                            <th>Fechas generadas</th>
                            <th>Costo</th>  
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>`;

        let totalCost = 0;

        selected_services.forEach((service) => {
            contract_configurations =
                contract_configurations.concat(configurations);
            c_configs = contract_configurations.filter(
                (c) => c.service_id == service.id,
            );

            totalCost += parseFloat(service.cost) || 0;
            html += `
                        <tr id="table-service${service.id}">
                            <td><strong>${service.name}</strong></td>
                            <td>${service.type}</td>
                            <td>${service.line}</td>
                            <td id="service${service.id}-count-configs">${
                                c_configs ? c_configs.length : 0
                            }</td>
                            <td id="service${service.id}-count-dates">${
                                c_configs
                                    ? c_configs.reduce(
                                          (total, item) =>
                                              total + item.dates.length,
                                          0,
                                      )
                                    : 0
                            }</td>
                            <td class="text-success">$${
                                service.cost ?? 0.0
                            }</td>  
                            <td class="d-flex justify-content-center gap-1">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="configureService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Configurar servicio">
                                    <i class="bi bi-gear-fill"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeService(${
                                    service.id
                                })"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar servicio">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>`;
        });

        html += `
                    </tbody>
                    <tfoot class="table-info">
                        <tr>
                            <td colspan="5" class="text-end fw-bold">Total:</td>
                            <td class="fw-bold">$${totalCost.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
    } else {
        html =
            '<div class="alert alert-danger">No hay servicios seleccionados</div>';
    }

    $container.html(html);
}

// Función para remover servicio individual
function removeService(service_id) {
    // Desmarcar checkbox
    $(`.service-checkbox[value="${service_id}"]`)
        .prop("checked", false)
        .trigger("change");

    $("#table-service" + service_id).fadeOut(300, function () {
        $(this).remove();
    });

    selected_services = selected_services.filter((s) => s.id != service_id);

    if (typeof contract_configurations !== "undefined") {
        if (typeof delete_settings !== "undefined") {
            const configs_to_delete = contract_configurations.filter(
                (cc) => cc.service_id == service_id,
            );
            delete_settings = delete_settings.concat(
                configs_to_delete.map((c) => c.setting_id),
            );
            $("#delete-settings").val(JSON.stringify(delete_settings));
        }

        contract_configurations = contract_configurations.filter(
            (cc) => cc.service_id != service_id,
        );
        $("#contract-configurations").val(
            JSON.stringify(contract_configurations),
        );
    }

    if (typeof services_configuration !== "undefined") {
        services_configuration = services_configuration.filter(
            (sc) => sc.service_id == service_id,
        );
        $("#services").val(JSON.stringify(services_configuration));
    }

    // Actualizar visualización
    displaySelectedServices();
}

// Función para limpiar todos los servicios seleccionados
function clearAllServices() {
    $(".service-checkbox").prop("checked", false).trigger("change");
    selected_services = [];
    displaySelectedServices();
    showSuccessMessage("Todos los servicios han sido removidos");
}

function configureService(service_id) {
    const service = selected_services.find((item) => item.id == service_id);

    if (!service) {
        alert("Servicio no encontrado");
        return;
    }

    if(typeof was_services_updated !== "undefined") {
        was_services_updated = true;
        $("#was-services-updated").val("true");
    }

    $("#configurations-list").empty();
    $("#configureServiceModalLabel").text(
        "Configurar Servicio: " + service.name,
    );
    setServiceConfig(service);
    $("#configureServiceModal").modal("show");

    $("#serviceModal-prefix").val(prefixes[service.prefix]);
    $("#serviceModal-service").val(service.name);
    $("#serviceModal-type").val(service.type[0]);
    $("#serviceModal-bsline").val(service.line[0]);
    $("#serviceModal-cost").val(service.cost);
}

function setServiceConfig(service) {
    $("#service-prefix").val(
        service.prefix == 1
            ? "Control/Perimetro"
            : service.prefix == 2
              ? "Aplicación química"
              : service.prefix == 3
                ? "Aplicación de gel"
                : "Otro",
    );
    $("#service-name").val(service.name);
    $("#service-type").val(service.type);
    $("#service-line").val(service.line);
    $("#service-cost").val(service.cost);
    $("#service-id").val(service.id);
}
